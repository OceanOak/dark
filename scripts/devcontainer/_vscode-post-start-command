#!/usr/bin/env bash

set -euo pipefail

# Create log directory and file early, so logs are available from the start
mkdir -p rundir/logs/
LOG_FILE="rundir/logs/build-server.log"

# Clear old logs so health checks can accurately detect startup progress
rm -f rundir/logs/*.log

# Initialize the log file
touch "$LOG_FILE"

# Helper to log both to console and file
log() {
  echo "$@" | tee -a "$LOG_FILE"
}

log "=== Build started at $(date) ==="

log "Fetching and building tree-sitter library"
./scripts/build/build-tree-sitter.sh 2>&1 | tee -a "$LOG_FILE"

log "Starting build server"

ROOT_DIR="${DARK_CONFIG_ROOT_DIR:-/home/dark/app}"
git config --global --add safe.directory "$ROOT_DIR"

nohup ./scripts/build/_build-server --compile --watch &>> "$LOG_FILE" &

# It seems that if we don't sleep here, the server does not start properly in all cases
sleep 2

log "Build server started"
